From b4311048113448f4d7e8ade3a6992be6806d5c52 Mon Sep 17 00:00:00 2001
From: Pierrick Bouvier <pierrick.bouvier@linaro.org>
Date: Mon, 23 Feb 2026 10:25:15 -0800
Subject: plat/qemu/: initialize smmuv3 with RME

---
 plat/qemu/common/common.mk                 |  3 +++
 plat/qemu/common/qemu_bl31_setup.c         | 14 ++++++++++++++
 plat/qemu/qemu_sbsa/include/platform_def.h |  2 ++
 3 files changed, 19 insertions(+)

diff --git a/plat/qemu/common/common.mk b/plat/qemu/common/common.mk
index 6e1e1aa..9c7a4c1 100644
--- a/plat/qemu/common/common.mk
+++ b/plat/qemu/common/common.mk
@@ -75,6 +75,9 @@ BL31_SOURCES		+=	${QEMU_CPU_LIBS}				\
 				${PLAT_QEMU_COMMON_PATH}/aarch64/plat_helpers.S	\
 				${PLAT_QEMU_COMMON_PATH}/qemu_bl31_setup.c	\
 				common/fdt_fixup.c				\
+				drivers/arm/smmu/smmu_v3.c                      \
+				drivers/delay_timer/delay_timer.c		\
+				drivers/delay_timer/generic_delay_timer.c       \
 				${QEMU_GIC_SOURCES}
 
 # CPU flag enablement
diff --git a/plat/qemu/common/qemu_bl31_setup.c b/plat/qemu/common/qemu_bl31_setup.c
index a350ce5..9e8ffc0 100644
--- a/plat/qemu/common/qemu_bl31_setup.c
+++ b/plat/qemu/common/qemu_bl31_setup.c
@@ -8,6 +8,8 @@
 
 #include <common/bl_common.h>
 #include <drivers/arm/pl061_gpio.h>
+#include <drivers/arm/smmu_v3.h>
+#include <drivers/generic_delay_timer.h>
 #include <lib/gpt_rme/gpt_rme.h>
 #if TRANSFER_LIST
 #include <transfer_list.h>
@@ -105,6 +107,8 @@ void bl31_early_platform_setup2(u_register_t arg0, u_register_t arg1,
 	sbsa_platform_init();
 #endif
 
+	generic_delay_timer_init();
+
 	/*
 	 * Check params passed from BL2
 	 */
@@ -290,6 +294,16 @@ void bl31_plat_arch_setup(void)
 		ERROR("gpt_runtime_init() failed!\n");
 		panic();
 	}
+
+	/* TODO: smmuv3 init can fail */
+	if (smmuv3_security_init(PLAT_QEMU_SMMUV3_BASE) != 0) {
+		ERROR("smmuv3_security_init() failed!\n");
+		panic();
+	}
+	if (smmuv3_init(PLAT_QEMU_SMMUV3_BASE) != 0) {
+		ERROR("smmuv3_security_init() failed!\n");
+		panic();
+	}
 #endif /* ENABLE_RME */
 
 }
diff --git a/plat/qemu/qemu_sbsa/include/platform_def.h b/plat/qemu/qemu_sbsa/include/platform_def.h
index 6849c5f..f38e8e1 100644
--- a/plat/qemu/qemu_sbsa/include/platform_def.h
+++ b/plat/qemu/qemu_sbsa/include/platform_def.h
@@ -498,6 +498,8 @@ CASSERT((PLAT_QEMU_L0_GPT_BASE & (PLAT_QEMU_L0_GPT_SIZE - 1)) == 0,
 
 /* When RME is enabled, the base of NS DRAM is moved forward after the RMM */
 #define NS_DRAM0_BASE_OFFSET	REALM_DRAM_SIZE
+#define PLAT_QEMU_SMMUV3_BASE              UL(0x60050000)
+#define PLAT_ARM_SMMUV3_ROOT_REG_OFFSET    UL(0x20000)
 #endif /* !ENABLE_RME */
 
 #endif /* PLATFORM_DEF_H */
-- 
2.47.3

